D3D11TextureMediaSink

The D3D11TexutreMediaSink is a custom MediaSink for MediaSession that outputs videos in the form of direct3D11 textures (ID3D11Texture2D). It was based on microsoft's DX11VideoRenderer sample.

When you build a MediaSession, you can register the D3D11TextureMediaSink as a video renderer to retrieve an IMFSample COM object that contains a framed image when the video is played. This IMFSample media buffer contains id3D11Texture2D resources.
The texture format is fixed in DXGI_FORMAT_B8G8R8A8_UNorm.
Up to five output textures that can be cached by the scheduler.
Use D3D11/DXVA2.0 for decoded video processing (deinterlacing or color conversion). XVP (Media Foundation Transcode Video Processor) is not supported.
It does not support IMFActivate.
Registration to the registry is not supported.
Solution Configuration

D3D11TextureMediaSink Project (C++)

Generates D3D11TextureMediaSink.lib/dll.
D3D11TextureMediaSinkDemo Project (C++)

Sample to play a video using D3D11TextureMediaSink.lib/dll.
D3D11TextureMediaSinkDemoCShart Project (C#)

This is the C# version of the sample that uses D3D11TextureMediaSink.dll to play videos.
To work with DirectX and Media Foundation in C#, get SharpDX and MediaFoundation from NuGet at build time.
Development and operating requirements

Windows 10 October 2018 Update (1809)
DirectX 11.0
Visual Studio Community 2017 Version 15.9.7
C++
Windows 10 SDK for October 2018 Update (10.0.17763.0)
Visual Studio 2017 (v141) Toolset
C #
Visual C# 7.0
.NET Framework 4.7.1
License

MIT License
Using

(1) Initialization

First, on the app side, you've created id3D11Device and IMFDXGIDeviceManager.

The D3D11TextureMediaSink does not use the IMFDXGIDeviceManager lock feature and uses the passed ID3D11Device as is.
Therefore, id3D111Device must be set to ID3D10Multithread::SetMultithreadProtected(TRUE).
D3D11TextureMediaSink generates an IMFMediaSink object with the CreateD3D11TextureMediaSink function.
The argument passes the IMFDXGIDeviceManager object and id3D11Device object generated by the app.

The D3D11TextureMediaSink object is generated and received through the IMFMediaSink interface.
HRESULT hr;
hr = CreateD3D11TextureMediaSink (
IID_IMFMediaSink,
(void**) &m_pMediaSink, // IMFMediaSink* m_pMediaSink
m_pDXGIDeviceManager, // ImfDXGIDeviceManager created
m_pD3DDevice); Id3D11Device created
Get the IMFAttributes needed to receive the video frame from D3D11TextureMediaSink.
hr = m_pMediaSink->QueryInterface (
IID_IMFAttributes, 
(void**)&m_pMediaSinkAttributes); IMFAttributes* m_pMediaSinkAttributes
(2) Building MediaSession

Build a MediaSession.
When you create a partial topology, assign the video output node (IMFTopologyNode) the first IMFStreamSink object that can be retrieved from the D3D11TextureMediaSink.
Gets the IMFStreamSink with ID 0 (fixed value) from IMFMediaSink.
IMFStreamSink* pStreamSink;
hr = pMediaSink->GetStreamSinkById(0, &pStreamSinkSink);

Assign sIMFStreamSink to the output node.
hr = pOutputNode->SetObject(pStreamSink); IMFTopologyNode* pOutputNode;
Get and draw video frames

Starts playing MediaSession.
Gets the frame of the video (IMFSample) from the TMS_SAMPLE attribute of D3D11TextureMediaSink.
hr = m_pMediaSinkAttributes->GetUnknown (
TMS_SAMPLE, // GUID defined in D3D11TextureMediaSink.h
IID_IMFSample,
(void**)&pSample); IMFSample* pSample
Gets id3D11Texture2D from the imfsample obtained.
Gets the media buffer from IMFSample.
IMFMediaBuffer* pMediaBuffer;
hr = pSample->GetBufferByIndex(0, &pMediaBuffer);

Gets the DXGI buffer from the media buffer.
IMFDXGIBuffer* pDXGIBuffer;
hr = pMediaBuffer->QueryInterface(IID_IMFDXGIBuffer, (void**)&pDXGIBuffer);

Gets texture2D from dxgi buffer.
ID3D11Texture2D* pTexture2D;
hr = pDXGIBuffer->GetResource(IID_ID3D11Texture2D, (void**)&pTexture2D);

Gets the texture2D subresource index.
UINT subIndex;
hr = pDXGIBuffer->GetSubresourceIndex(&subIndex);
Draws the retrieved ID3D11Texture2D resource in the app's preferred way.
(abbreviated)
When you're done drawing, release imfsample.
pTexture2D->Release();
pDXGIBuffer->Release();
pMediaBufer->Release();
pSample->Release();
hr = m_pMediaSinkAttributes->SetUnknown(TMS_SAMPLE, NULL);
Note:
D3D11TextureMediaSink follows its internal scheduler and always replaces the IMFSample provided by the TMS_SAMPLE attribute with the latest one to display now.
When the app calls IMFAttributes::GetUnknown() on the TMS_SAMPLE attribute, D3D1TextureMediaSink holds (lock) this IMFSample replacement operation.
When the app finishes drawing imfSample and this is no longer needed, call IMFAttributes::SetUnknown() to declare release. When this is called, D3D11TexutreMediaSink resumes the latest IMFSample replacement work on schedule.

Be more careful:
ImfSample replacement work should not be put on hold for a long time.
For example, if you set an ID3D11Texture2D resource from IMFSample to a pixel shader, you must keep it until the shader is executed.
In such cases, it is recommended that you copy the image to another resource for use.
